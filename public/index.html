<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Kanban Pro V2 - Brandon & Scarlet</title>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Config -->
    <script src="config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-column: #1e293b;
            --bg-hover: #2d3a52;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #ec4899;
            --accent-hover: #db2777;
            --border: #334155;
            --overdue: #dc2626;
            --priority-low: #10b981;
            --priority-medium: #f59e0b;
            --priority-high: #ef4444;
            --priority-urgent: #dc2626;
            --brandon: #3b82f6;
            --scarlet: #ec4899;
            --streak-fire: #f97316;
            --gold: #fbbf24;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .version-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .level-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #000;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-column);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 0;
            padding: 0 30px;
            background: var(--bg-main);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 77px;
            z-index: 999;
        }

        .nav-tab {
            padding: 16px 24px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            background: transparent;
            border: none;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .nav-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Main Content */
        .content {
            padding: 20px 30px;
            padding-bottom: 100px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid var(--border);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
        }

        .stat-value {
            font-size: 42px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .stat-value.low { color: var(--priority-low); }
        .stat-value.medium { color: var(--priority-medium); }
        .stat-value.high { color: var(--priority-high); }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Board */
        .board-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .column {
            background: var(--bg-column);
            border-radius: 12px;
            padding: 16px;
            min-width: 300px;
            flex: 1;
        }

        .column.overdue {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(220, 38, 38, 0.05));
            border: 2px solid var(--overdue);
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .column-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .count-badge {
            background: var(--border);
            color: var(--text-primary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 100px;
        }

        .task-card {
            background: var(--bg-main);
            border-radius: 8px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .task-card.priority-low { border-left-color: var(--priority-low); }
        .task-card.priority-medium { border-left-color: var(--priority-medium); }
        .task-card.priority-high { border-left-color: var(--priority-high); }
        .task-card.priority-urgent { border-left-color: var(--priority-urgent); }

        .task-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .task-description {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .task-tag {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .task-tag.brandon, .task-tag.Brandon { background: rgba(59, 130, 246, 0.2); color: var(--brandon); }
        .task-tag.scarlet, .task-tag.Scarlet { background: rgba(236, 72, 153, 0.2); color: var(--scarlet); }
        .task-tag.priority { color: white; }
        .task-tag.priority.low { background: var(--priority-low); }
        .task-tag.priority.medium { background: var(--priority-medium); }
        .task-tag.priority.high { background: var(--priority-high); }
        .task-tag.priority.urgent { background: var(--priority-urgent); }

        .task-date {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* Timer Widget */
        .timer-widget {
            position: fixed;
            top: 150px;
            right: 20px;
            background: var(--bg-card);
            border: 2px solid var(--accent);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 2000;
            min-width: 280px;
            transition: all 0.3s;
        }

        .timer-widget.collapsed .timer-body {
            display: none;
        }

        .timer-header {
            background: var(--accent);
            padding: 12px 16px;
            border-radius: 14px 14px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
        }

        .timer-header-title {
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timer-header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .timer-header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .timer-body {
            padding: 20px;
        }

        .timer-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .timer-time {
            font-size: 48px;
            font-weight: 800;
            font-family: 'Courier New', monospace;
            color: var(--accent);
            letter-spacing: 2px;
        }

        .timer-task-name {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 10px;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .timer-control-btn {
            flex: 1;
            background: var(--accent);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.2s;
        }

        .timer-control-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .timer-control-btn.secondary {
            background: var(--bg-column);
        }

        .timer-control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .timer-task-select {
            margin-bottom: 15px;
        }

        .timer-task-select label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .timer-task-select select {
            width: 100%;
            background: var(--bg-column);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 28px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            background: var(--bg-main);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        /* Revenue Page */
        .revenue-chart {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 20px 0;
        }

        .revenue-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .revenue-bar-label {
            min-width: 80px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .revenue-bar-fill {
            flex: 1;
            background: linear-gradient(90deg, var(--accent), var(--streak-fire));
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 13px;
            font-weight: 700;
            color: white;
            transition: all 0.3s;
        }

        .revenue-bar-fill:hover {
            transform: scaleX(1.02);
        }

        .revenue-entry {
            background: var(--bg-main);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .revenue-entry-info {
            flex: 1;
        }

        .revenue-entry-client {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .revenue-entry-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .revenue-entry-amount {
            font-size: 20px;
            font-weight: 700;
            color: var(--gold);
        }

        .revenue-entry-actions {
            display: flex;
            gap: 8px;
        }

        .revenue-entry-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 6px;
            transition: all 0.2s;
        }

        .revenue-entry-actions button:hover {
            color: var(--text-primary);
            transform: scale(1.2);
        }

        /* Clients Page */
        .client-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border);
            transition: all 0.3s;
            cursor: pointer;
        }

        .client-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .client-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .client-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .client-company {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .client-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .client-status.active { background: rgba(16, 185, 129, 0.2); color: var(--priority-low); }
        .client-status.lead { background: rgba(245, 158, 11, 0.2); color: var(--priority-medium); }

        .client-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .client-projects {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--border);
        }

        .client-projects-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .client-project-item {
            background: var(--bg-main);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent);
        }

        .client-project-name {
            font-weight: 600;
            margin-bottom: 6px;
        }

        .client-project-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .client-project-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-itinerary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-itinerary:hover {
            background: var(--accent-hover);
        }

        .btn-itinerary.secondary {
            background: var(--bg-column);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .board-container {
                flex-direction: column;
            }

            .column {
                min-width: 100%;
            }

            .timer-widget {
                top: auto;
                bottom: 10px;
                right: 10px;
                min-width: 240px;
            }

            .timer-time {
                font-size: 36px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">üöÄ Loading Kanban V2...</div>
    </div>

    <script>
        // Initialize Supabase
        const supabase = supabase.createClient(
            KANBAN_CONFIG.supabase.url,
            KANBAN_CONFIG.supabase.anonKey
        );

        // Global State
        let tasks = [];
        let clients = [];
        let projects = [];
        let revenue = [];
        let currentPage = 'board';
        let timerInterval = null;
        let timerSeconds = 0;
        let timerRunning = false;
        let timerTaskId = null;

        // Initialize App
        async function init() {
            console.log('üöÄ Initializing Kanban V2...');
            
            buildUI();
            await loadData();
            renderBoard();
            
            console.log('‚úÖ Kanban V2 initialized!');
        }

        function buildUI() {
            document.getElementById('app').innerHTML = `
                <!-- Header -->
                <div class="header">
                    <div class="logo">
                        <h1>${KANBAN_CONFIG.app.name}</h1>
                        <div class="version-badge">V2 ‚ö°</div>
                        <div class="level-badge" id="level-badge">Level 1</div>
                    </div>
                    <div class="header-actions">
                        <button class="btn" onclick="showAddTaskModal()">+ Add Task</button>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchPage('board')">üìã Board</button>
                    <button class="nav-tab" onclick="switchPage('calendar')">üìÖ Calendar</button>
                    <button class="nav-tab" onclick="switchPage('analytics')">üìä Analytics</button>
                    <button class="nav-tab" onclick="switchPage('revenue')">üí∞ Revenue</button>
                    <button class="nav-tab" onclick="switchPage('clients')">üë• Clients</button>
                    <button class="nav-tab" onclick="switchPage('achievements')">üèÜ Achievements</button>
                </div>

                <!-- Main Content -->
                <div class="content">
                    <!-- Board Page -->
                    <div id="page-board" class="page active">
                        <div class="board-container">
                            <div class="column overdue">
                                <div class="column-header">
                                    <div class="column-title">‚ö†Ô∏è Overdue <span class="count-badge" id="overdue-count">0</span></div>
                                </div>
                                <div class="task-list" id="overdue-list">
                                    <div class="empty-state">No overdue tasks</div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="column-header">
                                    <div class="column-title">üìù To Do <span class="count-badge" id="todo-count">0</span></div>
                                </div>
                                <div class="task-list" id="todo-list">
                                    <div class="empty-state">No tasks</div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="column-header">
                                    <div class="column-title">‚ö° In Progress <span class="count-badge" id="progress-count">0</span></div>
                                </div>
                                <div class="task-list" id="progress-list">
                                    <div class="empty-state">No tasks</div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="column-header">
                                    <div class="column-title">‚úÖ Done <span class="count-badge" id="done-count">0</span></div>
                                </div>
                                <div class="task-list" id="done-list">
                                    <div class="empty-state">No tasks</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar Page -->
                    <div id="page-calendar" class="page">
                        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">üìÖ Upcoming Schedule</h2>
                        <div id="calendar-content">
                            <div class="empty-state">No scheduled tasks</div>
                        </div>
                    </div>

                    <!-- Analytics Page -->
                    <div id="page-analytics" class="page">
                        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">üìä Analytics</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-completed">0</div>
                                <div class="stat-label">Completed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-ontime">0%</div>
                                <div class="stat-label">On-Time Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-streak">0üî•</div>
                                <div class="stat-label">Current Streak</div>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Page -->
                    <div id="page-revenue" class="page">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="font-size: 24px; font-weight: 700;">üí∞ Revenue & Earnings</h2>
                            <button class="btn" onclick="showAddRevenueModal()">+ Add Revenue</button>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value high" id="revenue-current">$0</div>
                                <div class="stat-label" id="revenue-current-label">This Month</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="revenue-change">‚Äî</div>
                                <div class="stat-label">vs Last Month</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="revenue-total">$0</div>
                                <div class="stat-label">All Time</div>
                            </div>
                        </div>

                        <div style="background: var(--bg-card); border-radius: 12px; padding: 20px; border: 2px solid var(--border); margin-bottom: 20px;">
                            <h3 style="font-weight: 700; margin-bottom: 15px;">üìä Monthly Revenue (Last 12 Months)</h3>
                            <div id="revenue-chart"></div>
                        </div>

                        <div style="background: var(--bg-card); border-radius: 12px; padding: 20px; border: 2px solid var(--border);">
                            <h3 style="font-weight: 700; margin-bottom: 15px;">üìù Revenue Entries</h3>
                            <div id="revenue-entries"></div>
                        </div>
                    </div>

                    <!-- Clients Page -->
                    <div id="page-clients" class="page">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="font-size: 24px; font-weight: 700;">üë• Client Management</h2>
                            <button class="btn" onclick="showAddClientModal()">+ Add Client</button>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="clients-total">0</div>
                                <div class="stat-label">Total Clients</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value low" id="clients-active">0</div>
                                <div class="stat-label">Active</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value high" id="clients-revenue">$0</div>
                                <div class="stat-label">Total Revenue</div>
                            </div>
                        </div>

                        <div id="clients-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;"></div>
                    </div>

                    <!-- Achievements Page -->
                    <div id="page-achievements" class="page">
                        <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 20px;">üèÜ Achievements</h2>
                        <div id="achievements-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;"></div>
                    </div>
                </div>

                <!-- Timer Widget -->
                <div class="timer-widget" id="timerWidget">
                    <div class="timer-header">
                        <div class="timer-header-title">‚è±Ô∏è Time Tracker</div>
                        <button class="timer-header-btn" onclick="toggleTimer()">‚ñº</button>
                    </div>
                    <div class="timer-body">
                        <div class="timer-display">
                            <div class="timer-time" id="timerDisplay">00:00</div>
                            <div class="timer-task-name" id="timerTaskName">No task selected</div>
                        </div>
                        <div class="timer-task-select">
                            <label>Working On:</label>
                            <select id="timerTaskSelector" onchange="selectTimerTask()">
                                <option value="">Select a task...</option>
                            </select>
                        </div>
                        <div class="timer-controls">
                            <button class="timer-control-btn" id="timerStartBtn" onclick="startTimer()">‚ñ∂Ô∏è Start</button>
                            <button class="timer-control-btn secondary" id="timerStopBtn" onclick="stopTimer()" disabled>‚èπÔ∏è Stop</button>
                        </div>
                    </div>
                </div>

                <!-- Add Task Modal -->
                <div id="addTaskModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">‚ûï Add New Task</div>
                            <button class="modal-close" onclick="closeAddTaskModal()">√ó</button>
                        </div>
                        <form id="addTaskForm" onsubmit="addTask(event)">
                            <div class="form-group">
                                <label class="form-label">Task Title *</label>
                                <input type="text" class="form-input" id="taskTitle" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-textarea" id="taskDescription"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Assigned To *</label>
                                <select class="form-select" id="taskAssignee" required>
                                    <option value="Brandon">Brandon</option>
                                    <option value="Scarlet">Scarlet</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Priority *</label>
                                <select class="form-select" id="taskPriority" required>
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Deadline</label>
                                <input type="datetime-local" class="form-input" id="taskDeadline">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estimated Time (minutes)</label>
                                <input type="number" class="form-input" id="taskEstimate" min="1">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeAddTaskModal()">Cancel</button>
                                <button type="submit" class="btn">Add Task</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Add Revenue Modal -->
                <div id="addRevenueModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üí∞ Add Revenue</div>
                            <button class="modal-close" onclick="closeAddRevenueModal()">√ó</button>
                        </div>
                        <form id="addRevenueForm" onsubmit="addRevenue(event)">
                            <div class="form-group">
                                <label class="form-label">Client *</label>
                                <select class="form-select" id="revenueClient" required>
                                    <option value="">Select client...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount ($) *</label>
                                <input type="number" class="form-input" id="revenueAmount" required min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Month *</label>
                                <select class="form-select" id="revenueMonth" required>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Year *</label>
                                <input type="number" class="form-input" id="revenueYear" required min="2020" max="2030">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-textarea" id="revenueNotes"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeAddRevenueModal()">Cancel</button>
                                <button type="submit" class="btn">Add Revenue</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Add Client Modal -->
                <div id="addClientModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">üë§ Add Client</div>
                            <button class="modal-close" onclick="closeAddClientModal()">√ó</button>
                        </div>
                        <form id="addClientForm" onsubmit="addClient(event)">
                            <div class="form-group">
                                <label class="form-label">Client Name *</label>
                                <input type="text" class="form-input" id="clientName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Company</label>
                                <input type="text" class="form-input" id="clientCompany">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="clientEmail">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-input" id="clientPhone">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status *</label>
                                <select class="form-select" id="clientStatus" required>
                                    <option value="lead">Lead</option>
                                    <option value="active" selected>Active</option>
                                    <option value="paused">Paused</option>
                                    <option value="archived">Archived</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-textarea" id="clientNotes"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="closeAddClientModal()">Cancel</button>
                                <button type="submit" class="btn">Add Client</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        // Load Data
        async function loadData() {
            try {
                console.log('üì• Loading data from Supabase...');
                
                const [tasksData, clientsData, projectsData, revenueData] = await Promise.all([
                    supabase.from('tasks').select('*').order('created_at', { ascending: false }),
                    supabase.from('clients').select('*').order('name'),
                    supabase.from('projects').select('*').order('name'),
                    supabase.from('revenue').select('*').order('date', { ascending: false })
                ]);

                if (tasksData.error) console.error('Tasks error:', tasksData.error);
                if (clientsData.error) console.error('Clients error:', clientsData.error);
                if (projectsData.error) console.error('Projects error:', projectsData.error);
                if (revenueData.error) console.error('Revenue error:', revenueData.error);

                tasks = tasksData.data || [];
                clients = clientsData.data || [];
                projects = projectsData.data || [];
                revenue = revenueData.data || [];

                console.log(`‚úÖ Loaded ${tasks.length} tasks, ${clients.length} clients, ${projects.length} projects, ${revenue.length} revenue entries`);

                // Populate client dropdowns
                populateClientDropdowns();
                
                // Populate timer task selector
                populateTimerTasks();
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
            }
        }

        function populateClientDropdowns() {
            const select = document.getElementById('revenueClient');
            if (select && clients.length > 0) {
                select.innerHTML = '<option value="">Select client...</option>' +
                    clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
        }

        function populateTimerTasks() {
            const select = document.getElementById('timerTaskSelector');
            if (select && tasks.length > 0) {
                const activeTasks = tasks.filter(t => t.status !== 'done');
                select.innerHTML = '<option value="">Select a task...</option>' +
                    activeTasks.map(t => `<option value="${t.id}">${t.title}</option>`).join('');
            }
        }

        // Render Board
        function renderBoard() {
            const now = new Date();
            
            // Check for overdue
            tasks.forEach(task => {
                if (task.deadline && new Date(task.deadline) < now && task.status !== 'done') {
                    task.status = 'overdue';
                }
            });

            const lists = {
                overdue: document.getElementById('overdue-list'),
                todo: document.getElementById('todo-list'),
                'in-progress': document.getElementById('progress-list'),
                done: document.getElementById('done-list')
            };

            Object.values(lists).forEach(list => {
                if (list) list.innerHTML = '';
            });

            tasks.forEach(task => {
                const card = createTaskCard(task);
                const listKey = task.status === 'in-progress' ? 'in-progress' : task.status;
                const targetList = lists[listKey] || lists.todo;
                if (targetList) targetList.appendChild(card);
            });

            // Update counts
            const counts = {
                overdue: tasks.filter(t => t.status === 'overdue').length,
                todo: tasks.filter(t => t.status === 'todo').length,
                progress: tasks.filter(t => t.status === 'in-progress').length,
                done: tasks.filter(t => t.status === 'done').length
            };

            ['overdue', 'todo', 'progress', 'done'].forEach(status => {
                const countEl = document.getElementById(`${status}-count`);
                if (countEl) countEl.textContent = counts[status] || 0;
            });

            // Empty states
            Object.entries(lists).forEach(([status, list]) => {
                if (list && list.children.length === 0) {
                    list.innerHTML = '<div class="empty-state">No tasks</div>';
                }
            });
        }

        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = `task-card priority-${task.priority || 'medium'}`;
            card.dataset.id = task.id;

            const description = task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : '';
            const deadline = task.deadline ? `<span class="task-date">‚è∞ ${formatDate(task.deadline)}</span>` : '';
            const estimate = task.estimated_minutes ? `<span class="task-date">‚è±Ô∏è ${task.estimated_minutes}min</span>` : '';

            card.innerHTML = `
                <div class="task-title">${escapeHtml(task.title)}</div>
                ${description}
                <div class="task-meta">
                    <span class="task-tag ${task.assignee || 'Brandon'}">${(task.assignee || 'BRANDON').toUpperCase()}</span>
                    <span class="task-tag priority ${task.priority || 'medium'}">${(task.priority || 'medium').toUpperCase()}</span>
                    ${deadline}
                    ${estimate}
                </div>
            `;

            card.addEventListener('click', () => changeStatus(task.id));

            return card;
        }

        async function changeStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const statuses = ['todo', 'in-progress', 'done'];
            const currentIndex = statuses.indexOf(task.status === 'overdue' ? 'todo' : task.status);
            const nextStatus = statuses[(currentIndex + 1) % statuses.length];

            const updates = {
                status: nextStatus,
                updated_at: new Date().toISOString()
            };

            if (nextStatus === 'done') {
                updates.completed_at = new Date().toISOString();
            }

            try {
                const { error } = await supabase
                    .from('tasks')
                    .update(updates)
                    .eq('id', taskId);

                if (error) throw error;

                await loadData();
                renderBoard();
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Failed to update task');
            }
        }

        async function addTask(event) {
            event.preventDefault();

            const newTask = {
                id: `task-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value || '',
                assignee: document.getElementById('taskAssignee').value,
                priority: document.getElementById('taskPriority').value,
                estimated_minutes: parseInt(document.getElementById('taskEstimate').value) || null,
                deadline: document.getElementById('taskDeadline').value || null,
                status: 'todo',
                subtasks: [],
                tags: '',
                time_tracked: 0,
                time_sessions: [],
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase.from('tasks').insert([newTask]);
                if (error) throw error;

                await loadData();
                renderBoard();
                closeAddTaskModal();
            } catch (error) {
                console.error('Error adding task:', error);
                alert('Failed to add task: ' + error.message);
            }
        }

        async function addRevenue(event) {
            event.preventDefault();

            const clientId = document.getElementById('revenueClient').value;
            const client = clients.find(c => c.id === clientId);
            
            const newRevenue = {
                id: `rev-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                client_id: clientId,
                client_name: client ? client.name : '',
                amount: parseFloat(document.getElementById('revenueAmount').value),
                month: parseInt(document.getElementById('revenueMonth').value),
                year: parseInt(document.getElementById('revenueYear').value),
                date: new Date().toISOString(),
                notes: document.getElementById('revenueNotes').value || '',
                type: 'project',
                created_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase.from('revenue').insert([newRevenue]);
                if (error) throw error;

                await loadData();
                renderRevenue();
                closeAddRevenueModal();
            } catch (error) {
                console.error('Error adding revenue:', error);
                alert('Failed to add revenue: ' + error.message);
            }
        }

        async function addClient(event) {
            event.preventDefault();

            const newClient = {
                id: `client-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                name: document.getElementById('clientName').value,
                company: document.getElementById('clientCompany').value || '',
                email: document.getElementById('clientEmail').value || '',
                phone: document.getElementById('clientPhone').value || '',
                status: document.getElementById('clientStatus').value,
                notes: document.getElementById('clientNotes').value || '',
                tags: [],
                contacts: [],
                locations: [],
                total_revenue: 0,
                created_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase.from('clients').insert([newClient]);
                if (error) throw error;

                await loadData();
                renderClients();
                closeAddClientModal();
            } catch (error) {
                console.error('Error adding client:', error);
                alert('Failed to add client: ' + error.message);
            }
        }

        // Page Switching
        function switchPage(page) {
            currentPage = page;
            
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const pageEl = document.getElementById(`page-${page}`);
            if (pageEl) pageEl.classList.add('active');

            if (page === 'revenue') renderRevenue();
            if (page === 'clients') renderClients();
            if (page === 'analytics') renderAnalytics();
            if (page === 'achievements') renderAchievements();
        }

        function renderRevenue() {
            // Current month
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            
            const currentRevenue = revenue.filter(r => r.month === currentMonth && r.year === currentYear);
            const currentTotal = currentRevenue.reduce((sum, r) => sum + (r.amount || 0), 0);
            
            // Last month
            const lastMonth = currentMonth === 1 ? 12 : currentMonth - 1;
            const lastYear = currentMonth === 1 ? currentYear - 1 : currentYear;
            const lastRevenue = revenue.filter(r => r.month === lastMonth && r.year === lastYear);
            const lastTotal = lastRevenue.reduce((sum, r) => sum + (r.amount || 0), 0);
            
            // All time
            const allTimeTotal = revenue.reduce((sum, r) => sum + (r.amount || 0), 0);

            document.getElementById('revenue-current').textContent = `$${currentTotal.toLocaleString()}`;
            document.getElementById('revenue-total').textContent = `$${allTimeTotal.toLocaleString()}`;
            
            // Change indicator
            const changeEl = document.getElementById('revenue-change');
            if (lastTotal === 0 && currentTotal === 0) {
                changeEl.innerHTML = '‚Äî';
            } else if (lastTotal === 0) {
                changeEl.innerHTML = '<span style="color: var(--priority-low);">‚Üë New</span>';
            } else {
                const pct = ((currentTotal - lastTotal) / lastTotal * 100).toFixed(0);
                if (currentTotal >= lastTotal) {
                    changeEl.innerHTML = `<span style="color: var(--priority-low);">‚Üë ${pct}%</span>`;
                } else {
                    changeEl.innerHTML = `<span style="color: var(--priority-high);">‚Üì ${Math.abs(pct)}%</span>`;
                }
            }

            // Chart
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const chartEl = document.getElementById('revenue-chart');
            const monthlyTotals = {};
            
            // Last 12 months
            for (let i = 11; i >= 0; i--) {
                const date = new Date(currentYear, currentMonth - 1 - i, 1);
                const m = date.getMonth() + 1;
                const y = date.getFullYear();
                const key = `${y}-${m}`;
                monthlyTotals[key] = revenue.filter(r => r.month === m && r.year === y).reduce((sum, r) => sum + r.amount, 0);
            }

            const maxValue = Math.max(...Object.values(monthlyTotals), 1);
            chartEl.innerHTML = Object.entries(monthlyTotals).map(([key, value]) => {
                const [year, month] = key.split('-');
                const width = (value / maxValue * 100).toFixed(1);
                return `
                    <div class="revenue-bar">
                        <div class="revenue-bar-label">${monthNames[parseInt(month) - 1]} ${year}</div>
                        <div class="revenue-bar-fill" style="width: ${width}%;">$${value.toLocaleString()}</div>
                    </div>
                `;
            }).join('');

            // Entries
            const entriesEl = document.getElementById('revenue-entries');
            if (revenue.length === 0) {
                entriesEl.innerHTML = '<div class="empty-state">No revenue entries yet</div>';
            } else {
                entriesEl.innerHTML = revenue.slice(0, 10).map(r => `
                    <div class="revenue-entry">
                        <div class="revenue-entry-info">
                            <div class="revenue-entry-client">${escapeHtml(r.client_name)}</div>
                            <div class="revenue-entry-meta">${monthNames[r.month - 1]} ${r.year}${r.notes ? ' ‚Ä¢ ' + escapeHtml(r.notes) : ''}</div>
                        </div>
                        <div class="revenue-entry-amount">$${r.amount.toLocaleString()}</div>
                    </div>
                `).join('');
            }
        }

        function renderClients() {
            const totalRevenue = revenue.reduce((sum, r) => sum + (r.amount || 0), 0);
            const activeClients = clients.filter(c => c.status === 'active').length;

            document.getElementById('clients-total').textContent = clients.length;
            document.getElementById('clients-active').textContent = activeClients;
            document.getElementById('clients-revenue').textContent = `$${totalRevenue.toLocaleString()}`;

            const grid = document.getElementById('clients-grid');
            if (clients.length === 0) {
                grid.innerHTML = '<div class="empty-state">No clients yet</div>';
            } else {
                grid.innerHTML = clients.map(client => {
                    const clientRevenue = revenue.filter(r => r.client_id === client.id).reduce((sum, r) => sum + r.amount, 0);
                    const clientProjects = projects.filter(p => p.client_id === client.id);
                    
                    return `
                        <div class="client-card">
                            <div class="client-card-header">
                                <div>
                                    <div class="client-name">${escapeHtml(client.name)}</div>
                                    ${client.company ? `<div class="client-company">${escapeHtml(client.company)}</div>` : ''}
                                </div>
                                <div class="client-status ${client.status}">${client.status.toUpperCase()}</div>
                            </div>
                            ${client.email || client.phone ? `
                                <div class="client-meta">
                                    ${client.email ? `<span>üìß ${client.email}</span>` : ''}
                                    ${client.phone ? `<span>üìû ${client.phone}</span>` : ''}
                                </div>
                            ` : ''}
                            <div style="margin: 15px 0; padding: 12px; background: var(--bg-main); border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--gold);">$${clientRevenue.toLocaleString()}</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Total Revenue</div>
                            </div>
                            ${clientProjects.length > 0 ? `
                                <div class="client-projects">
                                    <div class="client-projects-title">Projects (${clientProjects.length})</div>
                                    ${clientProjects.slice(0, 3).map(project => `
                                        <div class="client-project-item">
                                            <div class="client-project-name">${escapeHtml(project.name)}</div>
                                            <div class="client-project-meta">
                                                ${project.value ? `<span>üí∞ $${project.value.toLocaleString()}</span>` : ''}
                                                ${project.deadline ? `<span>üìÖ ${formatDate(project.deadline)}</span>` : ''}
                                            </div>
                                            ${project.itinerary_url ? `
                                                <div class="client-project-actions">
                                                    <button class="btn-itinerary" onclick="window.open('${project.itinerary_url}', '_blank')">üìã View Itinerary</button>
                                                    <button class="btn-itinerary secondary" onclick="downloadItinerary('${project.itinerary_url}')">‚¨áÔ∏è Download</button>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }
        }

        function renderAnalytics() {
            const completed = tasks.filter(t => t.status === 'done');
            document.getElementById('stat-completed').textContent = completed.length;

            const onTimeCount = completed.filter(t => !t.deadline || !t.completed_at || new Date(t.completed_at) <= new Date(t.deadline)).length;
            const onTimeRate = completed.length > 0 ? Math.round((onTimeCount / completed.length) * 100) : 0;
            document.getElementById('stat-ontime').textContent = `${onTimeRate}%`;

            const streak = calculateStreak();
            document.getElementById('stat-streak').textContent = `${streak}üî•`;
        }

        function renderAchievements() {
            const completed = tasks.filter(t => t.status === 'done');
            const achievements = [
                { id: 'first', name: 'First Steps', desc: 'Complete your first task', icon: 'üéØ', unlocked: completed.length >= 1 },
                { id: 'streak', name: 'Streak Master', desc: '7 day streak', icon: 'üî•', unlocked: calculateStreak() >= 7 },
                { id: 'revenue', name: 'First Revenue', desc: 'Add your first revenue entry', icon: 'üí∞', unlocked: revenue.length >= 1 },
                { id: 'client', name: 'Client Hunter', desc: 'Add 5 clients', icon: 'üë•', unlocked: clients.length >= 5 },
                { id: 'master', name: 'Task Master', desc: 'Complete 50 tasks', icon: 'üëë', unlocked: completed.length >= 50 }
            ];

            const grid = document.getElementById('achievements-grid');
            grid.innerHTML = achievements.map(a => `
                <div class="stat-card" style="${a.unlocked ? '' : 'opacity: 0.5; filter: grayscale(1);'}">
                    <div style="font-size: 48px; margin-bottom: 12px;">${a.icon}</div>
                    <div style="font-size: 16px; font-weight: 700; margin-bottom: 6px;">${a.name}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">${a.desc}</div>
                </div>
            `).join('');
        }

        function calculateStreak() {
            const completedDates = tasks
                .filter(t => t.status === 'done' && t.completed_at)
                .map(t => new Date(t.completed_at).toDateString())
                .filter((date, index, self) => self.indexOf(date) === index)
                .sort((a, b) => new Date(b) - new Date(a));

            let streak = 0;
            const today = new Date().toDateString();
            
            if (completedDates.includes(today)) {
                streak = 1;
                let currentDate = new Date();
                
                for (let i = 1; i < completedDates.length; i++) {
                    currentDate.setDate(currentDate.getDate() - 1);
                    if (completedDates.includes(currentDate.toDateString())) {
                        streak++;
                    } else {
                        break;
                    }
                }
            }
            
            return streak;
        }

        // Timer Functions
        function selectTimerTask() {
            const taskId = document.getElementById('timerTaskSelector').value;
            const task = tasks.find(t => t.id === taskId);
            
            timerTaskId = taskId;
            document.getElementById('timerTaskName').textContent = task ? task.title : 'No task selected';
        }

        function startTimer() {
            if (!timerTaskId) {
                alert('Please select a task first');
                return;
            }

            timerRunning = true;
            document.getElementById('timerStartBtn').style.display = 'none';
            document.getElementById('timerStopBtn').disabled = false;

            timerInterval = setInterval(() => {
                timerSeconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            if (!timerRunning) return;

            timerRunning = false;
            clearInterval(timerInterval);
            
            document.getElementById('timerStartBtn').style.display = 'block';
            document.getElementById('timerStopBtn').disabled = true;

            // Save time to task
            if (timerTaskId && timerSeconds > 0) {
                const task = tasks.find(t => t.id === timerTaskId);
                if (task) {
                    const timeTracked = (task.time_tracked || 0) + Math.floor(timerSeconds / 60);
                    supabase.from('tasks').update({ time_tracked: timeTracked }).eq('id', timerTaskId);
                }
            }

            timerSeconds = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const mins = Math.floor(timerSeconds / 60);
            const secs = timerSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function toggleTimer() {
            const widget = document.getElementById('timerWidget');
            widget.classList.toggle('collapsed');
            const icon = event.target;
            icon.textContent = widget.classList.contains('collapsed') ? '‚ñ≤' : '‚ñº';
        }

        // Modal Functions
        function showAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('active');
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('active');
            document.getElementById('addTaskForm').reset();
        }

        function showAddRevenueModal() {
            const now = new Date();
            document.getElementById('revenueMonth').value = now.getMonth() + 1;
            document.getElementById('revenueYear').value = now.getFullYear();
            document.getElementById('addRevenueModal').classList.add('active');
        }

        function closeAddRevenueModal() {
            document.getElementById('addRevenueModal').classList.remove('active');
            document.getElementById('addRevenueForm').reset();
        }

        function showAddClientModal() {
            document.getElementById('addClientModal').classList.add('active');
        }

        function closeAddClientModal() {
            document.getElementById('addClientModal').classList.remove('active');
            document.getElementById('addClientForm').reset();
        }

        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.toDateString() === today.toDateString()) return 'Today';
            if (date.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
            
            return date.toLocaleDateString('en-AU', { month: 'short', day: 'numeric' });
        }

        function downloadItinerary(url) {
            const a = document.createElement('a');
            a.href = url;
            a.download = url.split('/').pop();
            a.click();
        }

        // Initialize
        init();

        // Auto-refresh every 5 minutes
        setInterval(async () => {
            await loadData();
            if (currentPage === 'board') renderBoard();
            if (currentPage === 'revenue') renderRevenue();
            if (currentPage === 'clients') renderClients();
            if (currentPage === 'analytics') renderAnalytics();
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
