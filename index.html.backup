<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Kanban Pro V2 - Brandon & Scarlet</title>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Config -->
    <script src="config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-column: #1e293b;
            --bg-hover: #2d3a52;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #ec4899;
            --accent-hover: #db2777;
            --border: #334155;
            --overdue: #dc2626;
            --priority-low: #10b981;
            --priority-medium: #f59e0b;
            --priority-high: #ef4444;
            --priority-urgent: #dc2626;
            --brandon: #3b82f6;
            --scarlet: #ec4899;
            --streak-fire: #f97316;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .version-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .level-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #000;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-column);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 0;
            padding: 0 30px;
            background: var(--bg-main);
            border-bottom: 1px solid var(--border);
        }

        .nav-tab {
            padding: 16px 24px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .nav-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Main Content */
        .content {
            padding: 20px 30px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Board Page */
        .board-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .column {
            background: var(--bg-column);
            border-radius: 12px;
            padding: 16px;
            min-width: 300px;
            flex: 1;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .column-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .count-badge {
            background: var(--border);
            color: var(--text-primary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .column.overdue {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(220, 38, 38, 0.05));
            border: 2px solid var(--overdue);
        }

        .column.overdue .column-header {
            border-bottom-color: var(--overdue);
        }

        .column.overdue .count-badge {
            background: var(--overdue);
            color: white;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 100px;
        }

        .task-card {
            background: var(--bg-main);
            border-radius: 8px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .task-card.priority-low { border-left-color: var(--priority-low); }
        .task-card.priority-medium { border-left-color: var(--priority-medium); }
        .task-card.priority-high { border-left-color: var(--priority-high); }
        .task-card.priority-urgent { border-left-color: var(--priority-urgent); }

        .task-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .task-description {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .task-tag {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .task-tag.brandon, .task-tag.Brandon {
            background: rgba(59, 130, 246, 0.2);
            color: var(--brandon);
        }

        .task-tag.scarlet, .task-tag.Scarlet {
            background: rgba(236, 72, 153, 0.2);
            color: var(--scarlet);
        }

        .task-tag.priority {
            color: white;
        }

        .task-tag.priority.low { background: var(--priority-low); }
        .task-tag.priority.medium { background: var(--priority-medium); }
        .task-tag.priority.high { background: var(--priority-high); }
        .task-tag.priority.urgent { background: var(--priority-urgent); }

        .task-date {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .task-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
            transition: all 0.2s;
        }

        .task-action-btn:hover {
            color: var(--text-primary);
            transform: scale(1.2);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 24px;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: var(--text-secondary);
        }

        /* Calendar Page */
        .calendar-header {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .schedule-item {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 18px;
            display: flex;
            gap: 16px;
            align-items: center;
            transition: all 0.3s;
        }

        .schedule-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .schedule-time {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            min-width: 80px;
        }

        .schedule-content {
            flex: 1;
        }

        .schedule-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .schedule-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Analytics Page */
        .analytics-header {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .stat-value {
            font-size: 42px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .heatmap-section, .priority-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 8px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            background: var(--bg-card);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
            background: var(--accent);
            color: white;
        }

        .priority-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .priority-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .priority-count {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .priority-card.low .priority-count { color: var(--priority-low); }
        .priority-card.medium .priority-count { color: var(--priority-medium); }
        .priority-card.high .priority-count { color: var(--priority-high); }
        .priority-card.urgent .priority-count { color: var(--priority-urgent); }

        .priority-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Achievements Page */
        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .trophy-title {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .xp-progress {
            text-align: right;
        }

        .xp-bar-container {
            background: var(--bg-card);
            border-radius: 20px;
            height: 12px;
            width: 300px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .xp-bar {
            background: linear-gradient(90deg, var(--accent), var(--streak-fire));
            height: 100%;
            transition: width 0.5s;
            border-radius: 20px;
        }

        .xp-text {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .level-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }

        .achievement-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .achievement-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
        }

        .achievement-card.locked {
            opacity: 0.4;
        }

        .achievement-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .achievement-name {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .achievement-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .board-container {
                flex-direction: column;
            }

            .column {
                min-width: 100%;
            }

            .nav-tabs {
                overflow-x: auto;
            }

            .stats-grid, .priority-grid, .achievements-grid {
                grid-template-columns: 1fr;
            }

            .xp-bar-container {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">üöÄ Loading Kanban V2...</div>
    </div>

    <script>
        // Initialize Supabase client
        const supabase = supabase.createClient(
            KANBAN_CONFIG.supabase.url,
            KANBAN_CONFIG.supabase.anonKey
        );

        // Global State
        let tasks = [];
        let currentPage = 'board';

        // Initialize App
        async function init() {
            console.log('üöÄ Initializing Kanban V2...');
            console.log('üì¶ Supabase URL:', KANBAN_CONFIG.supabase.url);
            
            // Build UI
            document.getElementById('app').innerHTML = `
                <!-- Header -->
                <div class="header">
                    <div class="logo">
                        <h1>${KANBAN_CONFIG.app.name}</h1>
                        <div class="version-badge">V2</div>
                        <div class="level-badge" id="level-badge">‚ö° Level 1</div>
                    </div>
                    <div class="header-actions">
                        <button class="btn" onclick="showAddTaskModal()">+ Add Task</button>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="nav-tabs">
                    <div class="nav-tab active" onclick="switchPage('board')">
                        üìã Board
                    </div>
                    <div class="nav-tab" onclick="switchPage('calendar')">
                        üìÖ Calendar
                    </div>
                    <div class="nav-tab" onclick="switchPage('analytics')">
                        üìä Analytics
                    </div>
                    <div class="nav-tab" onclick="switchPage('achievements')">
                        üèÜ Achievements
                    </div>
                </div>

                <!-- Main Content -->
                <div class="content">
                    <!-- Board Page -->
                    <div id="page-board" class="page active">
                        <div class="board-container">
                            <div class="column overdue">
                                <div class="column-header">
                                    <div class="column-title">
                                        ‚ö†Ô∏è Overdue
                                        <span class="count-badge" id="overdue-count">0</span>
                                    </div>
                                </div>
                                <div class="task-list" id="overdue-list">
                                    <div class="empty-state">No overdue tasks</div>
                                </div>
                            </div>

                            <div class="column">
                                <div class="column-header">
                                    <div class="column-title">
                                        üìù To Do
                                        <span class="count-badge" id="todo-count">0</span>
                                    </div>
                                </div>
                                <div class="task-list" id="todo-list">
                                    <div class="empty-state">No tasks</div>
                                </div>
                            </div>

                            <div class="column">
                                <div class="column-header">
                                    <div class="column-title">
                                        ‚ö° In Progress
                                        <span class="count-badge" id="progress-count">0</span>
                                    </div>
                                </div>
                                <div class="task-list" id="progress-list">
                                    <div class="empty-state">No tasks</div>
                                </div>
                            </div>

                            <div class="column">
                                <div class="column-header">
                                    <div class="column-title">
                                        ‚úÖ Done
                                        <span class="count-badge" id="done-count">0</span>
                                    </div>
                                </div>
                                <div class="task-list" id="done-list">
                                    <div class="empty-state">No tasks</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar Page -->
                    <div id="page-calendar" class="page">
                        <div class="calendar-header">
                            üìÖ Upcoming Schedule (Next 24 Hours)
                        </div>
                        <div class="schedule-list" id="schedule-list">
                            <div class="empty-state">No scheduled tasks in the next 24 hours</div>
                        </div>
                    </div>

                    <!-- Analytics Page -->
                    <div id="page-analytics" class="page">
                        <div class="analytics-header">
                            üìä Analytics Dashboard
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-completed">0</div>
                                <div class="stat-label">Tasks Completed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-time">0min</div>
                                <div class="stat-label">Avg Completion Time</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-ontime">0%</div>
                                <div class="stat-label">On-Time Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-streak">0üî•</div>
                                <div class="stat-label">Current Streak</div>
                            </div>
                        </div>

                        <div class="heatmap-section">
                            <div class="section-title">Productivity Heatmap (By Hour)</div>
                            <div class="heatmap-grid" id="heatmap-grid"></div>
                        </div>

                        <div class="priority-section">
                            <div class="section-title">Priority Distribution</div>
                            <div class="priority-grid">
                                <div class="priority-card low">
                                    <div class="priority-count" id="priority-low-count">0</div>
                                    <div class="priority-label">low (0%)</div>
                                </div>
                                <div class="priority-card medium">
                                    <div class="priority-count" id="priority-medium-count">0</div>
                                    <div class="priority-label">medium (0%)</div>
                                </div>
                                <div class="priority-card high">
                                    <div class="priority-count" id="priority-high-count">0</div>
                                    <div class="priority-label">high (0%)</div>
                                </div>
                                <div class="priority-card urgent">
                                    <div class="priority-count" id="priority-urgent-count">0</div>
                                    <div class="priority-label">urgent (0%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Achievements Page -->
                    <div id="page-achievements" class="page">
                        <div class="achievements-header">
                            <div class="trophy-title">
                                üèÜ Trophy Case
                            </div>
                            <div class="xp-progress">
                                <div class="level-info">Progress to Level 2</div>
                                <div class="xp-bar-container">
                                    <div class="xp-bar" id="xp-bar" style="width: 0%"></div>
                                </div>
                                <div class="xp-text"><span id="current-xp">0</span> / 500 XP</div>
                            </div>
                        </div>

                        <div class="achievements-grid" id="achievements-grid">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Add Task Modal -->
                <div id="addTaskModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">‚ûï Add New Task</div>
                            <button class="modal-close" onclick="closeAddTaskModal()">√ó</button>
                        </div>
                        <form id="addTaskForm" onsubmit="addTask(event)">
                            <div class="form-group">
                                <label class="form-label">Task Title *</label>
                                <input type="text" class="form-input" id="taskTitle" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-textarea" id="taskDescription"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Assigned To *</label>
                                <select class="form-select" id="taskAssignee" required>
                                    <option value="Brandon">Brandon</option>
                                    <option value="Scarlet">Scarlet</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Priority *</label>
                                <select class="form-select" id="taskPriority" required>
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estimated Time (minutes)</label>
                                <input type="number" class="form-input" id="taskEstimate" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Deadline</label>
                                <input type="datetime-local" class="form-input" id="taskDeadline">
                            </div>
                            <button type="submit" class="btn" style="width: 100%;">Add Task</button>
                        </form>
                    </div>
                </div>
            `;

            // Load data
            await loadTasks();
            renderBoard();
            initHeatmap();
            
            console.log('‚úÖ Kanban V2 initialized!');
        }

        // Load Tasks from Supabase
        async function loadTasks() {
            try {
                console.log('üì• Loading tasks from Supabase...');
                const { data, error } = await supabase
                    .from('tasks')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('‚ùå Error loading tasks:', error);
                    alert('Error loading tasks: ' + error.message);
                    return;
                }

                tasks = data || [];
                console.log(`‚úÖ Loaded ${tasks.length} tasks`);
            } catch (error) {
                console.error('‚ùå Exception loading tasks:', error);
                tasks = [];
            }
        }

        // Render Board
        function renderBoard() {
            const lists = {
                overdue: document.getElementById('overdue-list'),
                todo: document.getElementById('todo-list'),
                'in-progress': document.getElementById('progress-list'),
                done: document.getElementById('done-list')
            };

            // Clear lists
            Object.values(lists).forEach(list => {
                if (list) list.innerHTML = '';
            });

            // Check for overdue tasks
            const now = new Date();
            tasks.forEach(task => {
                if (task.deadline && new Date(task.deadline) < now && task.status !== 'done') {
                    task.status = 'overdue';
                }
            });

            // Render tasks
            tasks.forEach(task => {
                const card = createTaskCard(task);
                const listKey = task.status === 'in-progress' ? 'in-progress' : task.status;
                const targetList = lists[listKey] || lists.todo;
                if (targetList) {
                    targetList.appendChild(card);
                }
            });

            // Update counts
            const counts = {
                overdue: tasks.filter(t => t.status === 'overdue').length,
                todo: tasks.filter(t => t.status === 'todo').length,
                progress: tasks.filter(t => t.status === 'in-progress').length,
                done: tasks.filter(t => t.status === 'done').length
            };

            const overdueEl = document.getElementById('overdue-count');
            const todoEl = document.getElementById('todo-count');
            const progressEl = document.getElementById('progress-count');
            const doneEl = document.getElementById('done-count');

            if (overdueEl) overdueEl.textContent = counts.overdue;
            if (todoEl) todoEl.textContent = counts.todo;
            if (progressEl) progressEl.textContent = counts.progress;
            if (doneEl) doneEl.textContent = counts.done;

            // Show empty states
            Object.entries(lists).forEach(([status, list]) => {
                if (list && list.children.length === 0) {
                    list.innerHTML = '<div class="empty-state">No tasks</div>';
                }
            });
        }

        // Create Task Card
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = `task-card priority-${task.priority || 'medium'}`;
            card.dataset.id = task.id;

            const description = task.description ? `<div class="task-description">${task.description}</div>` : '';
            const deadline = task.deadline ? `<span class="task-date">‚è∞ ${formatDate(task.deadline)}</span>` : '';
            const estimate = task.estimated_minutes ? `<span class="task-date">‚è±Ô∏è ${task.estimated_minutes}min</span>` : '';

            card.innerHTML = `
                <div class="task-title">${task.title}</div>
                ${description}
                <div class="task-meta">
                    <span class="task-tag ${task.assignee || 'Brandon'}">${(task.assignee || 'BRANDON').toUpperCase()}</span>
                    <span class="task-tag priority ${task.priority || 'medium'}">${(task.priority || 'medium').toUpperCase()}</span>
                    ${deadline}
                    ${estimate}
                </div>
                <div class="task-actions">
                    <button class="task-action-btn" onclick="changeStatus('${task.id}', event)" title="Change Status">‚ÜîÔ∏è</button>
                    <button class="task-action-btn" onclick="deleteTask('${task.id}', event)" title="Delete">üóëÔ∏è</button>
                </div>
            `;

            return card;
        }

        // Change Task Status
        async function changeStatus(taskId, event) {
            event.stopPropagation();
            
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const statuses = ['todo', 'in-progress', 'done'];
            const currentIndex = statuses.indexOf(task.status === 'overdue' ? 'todo' : task.status);
            const nextStatus = statuses[(currentIndex + 1) % statuses.length];

            const updates = {
                status: nextStatus,
                updated_at: new Date().toISOString()
            };

            if (nextStatus === 'done') {
                updates.completed_at = new Date().toISOString();
            }

            try {
                const { error } = await supabase
                    .from('tasks')
                    .update(updates)
                    .eq('id', taskId);

                if (error) throw error;

                await loadTasks();
                renderBoard();
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Failed to update task');
            }
        }

        // Delete Task
        async function deleteTask(taskId, event) {
            event.stopPropagation();
            
            if (!confirm('Delete this task?')) return;

            try {
                const { error } = await supabase
                    .from('tasks')
                    .delete()
                    .eq('id', taskId);

                if (error) throw error;

                await loadTasks();
                renderBoard();
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Failed to delete task');
            }
        }

        // Add Task
        async function addTask(event) {
            event.preventDefault();

            const newTask = {
                id: `task-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value || '',
                assignee: document.getElementById('taskAssignee').value,
                priority: document.getElementById('taskPriority').value,
                estimated_minutes: parseInt(document.getElementById('taskEstimate').value) || null,
                deadline: document.getElementById('taskDeadline').value || null,
                status: 'todo',
                subtasks: [],
                tags: '',
                time_tracked: 0,
                time_sessions: [],
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase
                    .from('tasks')
                    .insert([newTask]);

                if (error) throw error;

                await loadTasks();
                renderBoard();
                closeAddTaskModal();
            } catch (error) {
                console.error('Error adding task:', error);
                alert('Failed to add task: ' + error.message);
            }
        }

        // Page Switching
        function switchPage(page) {
            currentPage = page;
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.nav-tab').classList.add('active');

            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            const pageEl = document.getElementById(`page-${page}`);
            if (pageEl) {
                pageEl.classList.add('active');
            }

            if (page === 'calendar') renderCalendar();
            if (page === 'analytics') renderAnalytics();
            if (page === 'achievements') renderAchievements();
        }

        // Render Calendar
        async function renderCalendar() {
            const scheduleList = document.getElementById('schedule-list');
            if (!scheduleList) return;

            scheduleList.innerHTML = '<div class="empty-state">Calendar view coming soon...</div>';
        }

        // Render Analytics
        function renderAnalytics() {
            const completed = tasks.filter(t => t.status === 'done');
            
            const statCompleted = document.getElementById('stat-completed');
            if (statCompleted) {
                statCompleted.textContent = completed.length;
            }
            
            const avgTime = completed.length > 0 
                ? Math.round(completed.reduce((sum, t) => sum + (t.estimated_minutes || 0), 0) / completed.length)
                : 0;
            
            const statTime = document.getElementById('stat-time');
            if (statTime) {
                statTime.textContent = `${avgTime}min`;
            }

            const onTime = completed.filter(t => !t.deadline || new Date(t.completed_at) <= new Date(t.deadline)).length;
            const onTimeRate = completed.length > 0 ? Math.round((onTime / completed.length) * 100) : 0;
            
            const statOntime = document.getElementById('stat-ontime');
            if (statOntime) {
                statOntime.textContent = `${onTimeRate}%`;
            }

            const streak = calculateStreak();
            const statStreak = document.getElementById('stat-streak');
            if (statStreak) {
                statStreak.textContent = `${streak}üî•`;
            }

            // Priority distribution
            const priorities = { low: 0, medium: 0, high: 0, urgent: 0 };
            tasks.forEach(t => {
                const priority = t.priority || 'medium';
                if (priorities[priority] !== undefined) {
                    priorities[priority]++;
                }
            });

            const total = tasks.length || 1;
            Object.entries(priorities).forEach(([priority, count]) => {
                const percentage = Math.round((count / total) * 100);
                const countEl = document.getElementById(`priority-${priority}-count`);
                if (countEl) {
                    countEl.textContent = count;
                }
                const card = document.querySelector(`.priority-card.${priority} .priority-label`);
                if (card) {
                    card.textContent = `${priority} (${percentage}%)`;
                }
            });
        }

        // Initialize Heatmap
        function initHeatmap() {
            const grid = document.getElementById('heatmap-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            for (let i = 0; i < 24; i++) {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                cell.textContent = i;
                cell.title = `${i}:00`;
                grid.appendChild(cell);
            }
        }

        // Render Achievements
        function renderAchievements() {
            const completed = tasks.filter(t => t.status === 'done');
            let xp = completed.length * 10;

            const achievements = [
                { id: 'first-steps', name: 'First Steps', desc: 'Complete your first task', icon: 'üéØ', unlocked: completed.length >= 1 },
                { id: 'speed-demon', name: 'Speed Demon', desc: 'Complete a task under estimated time', icon: '‚ö°', unlocked: false },
                { id: 'marathon-runner', name: 'Marathon Runner', desc: 'Complete 5 tasks in one day', icon: 'üèÉ', unlocked: false },
                { id: 'streak-master', name: 'Streak Master', desc: 'Complete at least one task every day for 7 days', icon: 'üî•', unlocked: calculateStreak() >= 7 },
                { id: 'priority-pro', name: 'Priority Pro', desc: 'Complete all urgent tasks on time', icon: '‚≠ê', unlocked: false },
                { id: 'early-bird', name: 'Early Bird', desc: 'Complete a task before the deadline', icon: 'üåÖ', unlocked: false },
                { id: 'night-owl', name: 'Night Owl', desc: 'Complete a task after 8pm', icon: 'ü¶â', unlocked: false },
                { id: 'perfectionist', name: 'Perfectionist', desc: 'Complete 10 tasks without missing a deadline', icon: 'üíé', unlocked: false },
                { id: 'task-master', name: 'Task Master', desc: 'Complete 50 tasks total', icon: 'üëë', unlocked: completed.length >= 50 },
                { id: 'consistency-king', name: 'Consistency King', desc: 'Complete at least 3 tasks per day for 5 days straight', icon: 'üëë', unlocked: false }
            ];

            achievements.forEach(a => {
                if (a.unlocked) xp += 50;
            });

            const grid = document.getElementById('achievements-grid');
            if (grid) {
                grid.innerHTML = achievements.map(a => `
                    <div class="achievement-card ${a.unlocked ? '' : 'locked'}" data-id="${a.id}">
                        <div class="achievement-icon">${a.icon}</div>
                        <div class="achievement-name">${a.name}</div>
                        <div class="achievement-desc">${a.desc}</div>
                    </div>
                `).join('');
            }

            const xpBar = document.getElementById('xp-bar');
            const currentXpEl = document.getElementById('current-xp');
            
            if (xpBar) {
                const xpProgress = (xp / 500) * 100;
                xpBar.style.width = `${Math.min(xpProgress, 100)}%`;
            }
            
            if (currentXpEl) {
                currentXpEl.textContent = xp;
            }
        }

        // Calculate Streak
        function calculateStreak() {
            const completedDates = tasks
                .filter(t => t.status === 'done' && t.completed_at)
                .map(t => new Date(t.completed_at).toDateString())
                .filter((date, index, self) => self.indexOf(date) === index)
                .sort((a, b) => new Date(b) - new Date(a));

            let streak = 0;
            const today = new Date().toDateString();
            
            if (completedDates.includes(today)) {
                streak = 1;
                let currentDate = new Date();
                
                for (let i = 1; i < completedDates.length; i++) {
                    currentDate.setDate(currentDate.getDate() - 1);
                    if (completedDates.includes(currentDate.toDateString())) {
                        streak++;
                    } else {
                        break;
                    }
                }
            }
            
            return streak;
        }

        // Format Date
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.toDateString() === today.toDateString()) return 'Today';
            if (date.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
            
            return date.toLocaleDateString('en-AU', { month: 'short', day: 'numeric' });
        }

        // Modal Functions
        function showAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('active');
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('active');
            document.getElementById('addTaskForm').reset();
        }

        // Initialize
        init();

        // Auto-refresh every 5 minutes
        setInterval(async () => {
            await loadTasks();
            renderBoard();
            if (currentPage === 'analytics') renderAnalytics();
            if (currentPage === 'achievements') renderAchievements();
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
